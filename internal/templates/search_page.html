<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Songs - SongShare</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <script>
        async function createShareLink(url, button) {
            const originalText = button.innerHTML;
            button.innerHTML = 'Creating link...';
            button.disabled = true;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
                
                const response = await fetch('/api/v1/songs/resolve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'HX-Request': 'true'
                    },
                    body: JSON.stringify({ url: url }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                if (response.ok) {
                    // Try to get redirect URL from response body
                    const responseData = await response.json();
                    console.log('Response data:', responseData);
                    
                    const redirectUrl = responseData.redirect || 
                                      response.headers.get('HX-Redirect') || 
                                      response.headers.get('hx-redirect');
                    console.log('Redirect URL:', redirectUrl);
                    
                    if (redirectUrl) {
                        window.location.href = redirectUrl;
                        return;
                    } else {
                        console.log('No redirect URL found in headers or body');
                    }
                }
                
                // Fallback: show error
                console.log('Request failed or no redirect found');
                button.innerHTML = 'Error - Check Console';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 5000);
                
            } catch (error) {
                console.error('Error creating share link:', error);
                if (error.name === 'AbortError') {
                    button.innerHTML = 'Timeout - Try Again';
                } else {
                    button.innerHTML = 'Network Error';
                }
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 5000);
            }
        }
        
        // Reset any stuck Share buttons
        function resetStuckButtons() {
            const stuckButtons = document.querySelectorAll('button[onclick*="createShareLink"]');
            let resetCount = 0;
            stuckButtons.forEach(button => {
                if (button.innerHTML === 'Creating link...' || button.disabled) {
                    console.log('Resetting stuck button:', button.innerHTML, 'disabled:', button.disabled);
                    button.innerHTML = 'Share';
                    button.disabled = false;
                    resetCount++;
                }
            });
            if (resetCount > 0) {
                console.log('Reset', resetCount, 'stuck buttons');
            }
        }
        
        // Reset buttons on page load (including back navigation)
        document.addEventListener('DOMContentLoaded', resetStuckButtons);
        
        // Reset buttons when returning from back/forward navigation
        window.addEventListener('pageshow', function(event) {
            // This fires when page is shown from cache (back button)
            resetStuckButtons();
        });
        
        // Reset buttons when HTMX loads new content  
        document.body.addEventListener('htmx:afterSwap', resetStuckButtons);
        
        // Also reset buttons periodically in case we miss events
        setInterval(resetStuckButtons, 2000);
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 2rem auto; padding: 1rem; line-height: 1.6; }
        .header { text-align: center; margin-bottom: 2rem; }
        .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: #1a202c; }
        .header p { color: #718096; font-size: 1.1rem; }
        
        .search-container { margin-bottom: 2rem; }
        .search-form { display: flex; flex-direction: column; gap: 1rem; }
        .search-input { padding: 1rem; font-size: 1.1rem; border: 2px solid #e2e8f0; border-radius: 8px; outline: none; transition: border-color 0.2s; }
        .search-input:focus { border-color: #4299e1; }
        
        .filters { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .filter-group label { font-size: 0.9rem; font-weight: 500; color: #4a5568; }
        .filter-select { padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 4px; background: white; }
        
        .loading { display: none; text-align: center; color: #718096; margin: 1rem 0; }
        .htmx-request .loading { display: block; }
        
        .search-results { margin-top: 2rem; }
        .result-item { display: flex; gap: 1rem; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 1rem; transition: box-shadow 0.2s; }
        .result-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .result-image { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
        .result-image-placeholder { width: 80px; height: 80px; border-radius: 8px; background: #f7fafc; display: flex; align-items: center; justify-content: center; color: #a0aec0; font-size: 2rem; }
        
        .result-content { flex-grow: 1; }
        .result-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem; color: #1a202c; }
        .explicit-indicator { display: inline-block; background: #666; color: white; font-size: 0.7rem; font-weight: bold; padding: 2px 4px; margin-left: 6px; border-radius: 2px; vertical-align: top; }
        .result-artist { color: #4a5568; margin-bottom: 0.25rem; }
        .result-album { color: #718096; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .result-platforms { display: flex; gap: 0.5rem; align-items: center; }
        .platform-badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; display: flex; align-items: center; gap: 0.25rem; background: white; color: black; border: 2px solid #ddd; transition: all 0.2s ease; cursor: pointer; }
        .platform-badge:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .platform-badge-icon { width: 14px; height: 14px; flex-shrink: 0; object-fit: contain; }
        .platform-spotify { border-color: #1db954; }
        .platform-spotify:hover { border-color: #1ED760; background: #f8fff9; }
        .platform-apple-music { border-color: #fa243c; }
        .platform-apple-music:hover { border-color: #f94c57; background: #fff8f9; }
        .platform-tidal { border-color: #000000; }
        .platform-tidal:hover { border-color: #333333; background: #f8f8f8; }
        .platform-local { border-color: #4299e1; }
        .platform-local:hover { border-color: #63b3ed; background: #f7fafc; }
        
        .result-actions { display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end; }
        .action-btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-block; text-align: center; }
        .action-primary { background: #4299e1; color: white; }
        .action-primary:hover { background: #3182ce; }
        .action-secondary { background: #e2e8f0; color: #4a5568; }
        .action-secondary:hover { background: #cbd5e0; }
        .action-small { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
        
        .platform-actions { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.5rem; }
        
        .action-success { text-align: center; padding: 1rem; background: #f0fff4; border: 1px solid #68d391; border-radius: 4px; }
        .action-success p { margin: 0 0 0.5rem 0; color: #2f855a; font-weight: 500; }
        
        .no-results { text-align: center; color: #718096; margin: 2rem 0; }
        .empty-state { text-align: center; color: #718096; margin: 3rem 0; }
        
        .footer { text-align: center; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #e2e8f0; color: #a0aec0; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎵 SongShare Search</h1>
        <p>Find your favorite songs across all platforms</p>
    </div>

    <div class="search-container">
        <form class="search-form" hx-get="/api/v1/search/results" hx-target="#search-results" hx-trigger="submit, keyup delay:500ms from:input[name='q']" hx-indicator="#loading">
            <input 
                type="text" 
                name="q" 
                class="search-input" 
                placeholder="Search for songs, artists, or albums..." 
                value="{{.Query}}"
                autocomplete="off"
            >
            
            <div class="filters">
                <div class="filter-group">
                    <label for="platform">Platform</label>
                    <select name="platform" class="filter-select" hx-get="/api/v1/search/results" hx-target="#search-results" hx-trigger="change" hx-include="closest form" hx-indicator="#loading">
                        <option value="">All Platforms</option>
                        <option value="apple_music">Apple Music</option>
                        <option value="spotify">Spotify</option>
                        <option value="tidal">Tidal</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="limit">Results</label>
                    <select name="limit" class="filter-select" hx-get="/api/v1/search/results" hx-target="#search-results" hx-trigger="change" hx-include="closest form" hx-indicator="#loading">
                        <option value="10">10 results</option>
                        <option value="25">25 results</option>
                        <option value="50">50 results</option>
                    </select>
                </div>
            </div>
        </form>
        
        <div id="loading" class="loading">🔍 Searching...</div>
    </div>

    <div id="search-results" class="search-results">
        {{if .Query}}
            <div hx-get="/api/v1/search/results?q={{.Query}}" hx-trigger="load" hx-target="this" hx-indicator="#loading"></div>
        {{else}}
            <div class="empty-state">
                <p>Start typing to search for songs across Spotify, Apple Music, Tidal, and your local library.</p>
            </div>
        {{end}}
    </div>

    <div class="footer">
        <p>Powered by SongShare | <a href="/" style="color: #4299e1;">Home</a></p>
    </div>

    <script>
        // Update URL when search happens
        function updateSearchURL(query) {
            const encodedQuery = encodeURIComponent(query.trim());
            const newURL = encodedQuery ? '/search/' + encodedQuery : '/search';
            
            // Only update URL if it's different to avoid unnecessary history entries
            if (window.location.pathname + window.location.search !== newURL) {
                window.history.pushState({}, '', newURL);
            }
        }

        // Progressive enhancement for platform badges
        function enhanceSearchResults() {
            // Find all result items with ISRCs that might be enhanced
            const resultItems = document.querySelectorAll('.result-item[id^="result-"]');
            
            resultItems.forEach((item, index) => {
                const resultId = item.id;
                const platformsContainer = item.querySelector('.result-platforms');
                
                if (!platformsContainer || platformsContainer.children.length >= 3) {
                    return; // Skip if already has many platforms
                }
                
                // Add a delay to avoid overwhelming the server
                setTimeout(() => {
                    const currentBadgeCount = platformsContainer.children.length;
                    
                    // Poll for enhanced badges
                    fetch('/api/v1/search/results/' + resultId + '/badges')
                        .then(response => response.text())
                        .then(html => {
                            if (html && html.trim() !== '') {
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = html;
                                const newBadgeCount = tempDiv.children.length;
                                
                                // Only update if we got more platforms
                                if (newBadgeCount > currentBadgeCount) {
                                    platformsContainer.innerHTML = html;
                                    console.log('Enhanced ' + resultId + ': ' + currentBadgeCount + ' → ' + newBadgeCount + ' platforms');
                                }
                            }
                        })
                        .catch(err => {
                            // Silently ignore errors for progressive enhancement
                            console.debug('Enhancement failed for', resultId, err);
                        });
                }, index * 200); // Stagger requests by 200ms each
            });
        }

        // Auto-enhance search results after they load
        document.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.pathInfo.requestPath.includes('/search/results')) {
                // Give a moment for the DOM to update, then enhance
                setTimeout(enhanceSearchResults, 500);
            }
        });

        // Listen for search input changes with debouncing
        let searchTimeout;
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.querySelector('input[name="q"]');
            
            if (searchInput) {
                // Update URL on input with debouncing
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    const query = this.value;
                    
                    searchTimeout = setTimeout(() => {
                        updateSearchURL(query);
                    }, 500); // Match HTMX delay
                });
                
                // Also update on form submit
                searchInput.closest('form').addEventListener('submit', function(e) {
                    e.preventDefault(); // Prevent actual form submission since HTMX handles it
                    updateSearchURL(searchInput.value);
                });
            }
        });
    </script>
</body>
</html>